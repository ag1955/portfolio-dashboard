<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AG Group | Investment Dashboard</title>

<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
:root {
  --bg:#f4f6f8;
  --card:#ffffff;
  --primary:#1a365d;
  --muted:#718096;
}

body {
  margin:0;
  font-family: Inter, system-ui, sans-serif;
  background:var(--bg);
  color:#2d3748;
}

header {
  background:var(--primary);
  color:white;
  padding:20px 30px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

header h1 { margin:0; font-size:22px; }
header small { color:#cbd5e0; font-size:13px; }

button {
  padding:6px 12px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-size:12px;
}

.container {
  padding:25px;
  max-width:1500px;
  margin:auto;
}

.card {
  background:var(--card);
  border-radius:12px;
  padding:20px;
  box-shadow:0 4px 6px rgba(0,0,0,.05);
  margin-bottom:20px;
}

.filters {
  display:flex;
  gap:20px;
  flex-wrap:wrap;
}

.filter-group label {
  font-size:11px;
  font-weight:700;
  color:var(--muted);
}

.filter-group select {
  width:180px;
  height:100px;
}

.grid {
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:20px;
}

.table-wrap {
  max-height:600px;
  overflow:auto;
}

table {
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}

th {
  position:sticky;
  top:0;
  background:#f7fafc;
  padding:10px;
}

td {
  padding:10px;
  border-bottom:1px solid #edf2f7;
}

#drillInfo {
  display:none;
  background:#fffaf0;
  border:1px solid #feebc8;
  padding:10px;
  border-radius:8px;
  margin-bottom:10px;
}

.footer {
  font-size:12px;
  color:var(--muted);
  text-align:right;
}
</style>
</head>

<body>

<header>
  <div>
    <h1>AG Group â€“ Investment Portfolio</h1>
    <small>Period: <b id="periodText">--</b></small>
  </div>
  <div>
    <button onclick="exportPDF()">ðŸ“„ PDF</button>
    <button onclick="exportExcel()">ðŸ“Š Excel</button><br>
    <small id="lastUpdated">Last updated: --</small>
  </div>
</header>

<div class="container">

  <!-- FILTERS -->
  <div class="card filters">
    <div class="filter-group">
      <label>Investor</label><br>
      <select id="invF" multiple></select><br>
      <button onclick="clearFilter('invF')">Clear</button>
    </div>
    <div class="filter-group">
      <label>Company</label><br>
      <select id="comF" multiple></select><br>
      <button onclick="clearFilter('comF')">Clear</button>
    </div>
    <div class="filter-group">
      <label>Type</label><br>
      <select id="typF" multiple></select><br>
      <button onclick="clearFilter('typF')">Clear</button>
    </div>
    <div style="align-self:flex-end">
      <button onclick="resetAll()">Reset All</button>
    </div>
  </div>

  <!-- INSIGHTS -->
  <div class="grid">
    <div class="card">
      <h3>Company Concentration</h3>
      <div id="companyPie"></div>
    </div>
    <div class="card">
      <h3>Asset Mix</h3>
      <div id="typeDonut" style="height:420px"></div>
    </div>
  </div>

  <!-- REPOSITORY -->
  <div class="card">
    <h3>Detailed Investment Repository</h3>

    <div id="drillInfo">
      <span id="drillText"></span>
      <button onclick="clearDrill()">Clear Drill</button>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Investor</th>
            <th>Company</th>
            <th>Type</th>
            <th>Qty</th>
            <th>Value (â‚¹ L)</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

  <div class="footer">Confidential â€“ For Client Use Only</div>
</div>

<script>
const DATA_URL = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLhf6NIZ6o8k4JVQQt3XVFwAgb-5h0UL-saIgjtF4PJTzhY5bVQPBHDnwrw1XVYL4OtzfKFMV2GiVVMMocZHY-JSorOpIKofX6dT1b2m1mjGXaKZzVgCVPLzB4SSYM7oH2wmz5Zfwbd_D5rD4k27gqgIiYmvSE3hqenxPFkYukj3qg2uvnI1bf5_Vf1z7m0AEyRpb3ZX7eSdUxsRezbB8WlJc5GtpNsiZobew_SI2z_6XNxJ9QhL-agOK91Zd-0XbWLVftPiZCbnOXXUq-IbF3jQFET18Q&lib=MLfLtmcdnFe_9PafX9g6m-beUs6YUnKQP";

let rawData=[], currentData=[];

fetch(DATA_URL)
  .then(r=>r.json())
  .then(json=>{
    rawData = json.data || [];
    currentData = rawData;

    document.getElementById("periodText").innerText = json.period || "--";
    document.getElementById("lastUpdated").innerText =
      "Last updated: " + (json.lastUpdated || new Date().toLocaleString());

    initFilters();
    applyFilters();
  });

function initFilters(){
  fill('invF','Investor');
  fill('comF','Name of the Company');
  fill('typF','Type');
}

function fill(id,key){
  const sel=document.getElementById(id);
  const vals=[...new Set(rawData.map(d=>d[key]))].sort();
  sel.innerHTML='<option value="All" selected>All</option>' +
    vals.map(v=>`<option>${v}</option>`).join('');
  sel.onchange=applyFilters;
}

function getSel(id){
  return [...document.getElementById(id).selectedOptions].map(o=>o.value);
}

function applyFilters(){
  const iv=getSel('invF'), co=getSel('comF'), ty=getSel('typF');
  currentData = rawData.filter(d =>
    (iv.includes('All')||iv.includes(d.Investor)) &&
    (co.includes('All')||co.includes(d['Name of the Company'])) &&
    (ty.includes('All')||ty.includes(d.Type))
  );
  renderAll(currentData);
}

function clearFilter(id){
  [...document.getElementById(id).options].forEach(o=>o.selected=(o.value==='All'));
  applyFilters();
}

function resetAll(){
  ['invF','comF','typF'].forEach(clearFilter);
}

function renderAll(data){
  renderTable(data);
  renderCompanyPie(data);
  renderTypeDonut(data);
}

function renderTable(data){
  document.getElementById("tableBody").innerHTML=data.map(d=>`
    <tr>
      <td>${d.Investor}</td>
      <td>${d['Name of the Company']}</td>
      <td>${d.Type}</td>
      <td>${d.Qty}</td>
      <td>${((+d.Value||0)/100000).toFixed(2)}</td>
      <td>${d.DOA}</td>
    </tr>`).join('');
}

function renderCompanyPie(data){
  const map={}, small=[], total=data.reduce((a,b)=>a+(+b.Value||0),0)/100000;
  data.forEach(d=>map[d['Name of the Company']] = (map[d['Name of the Company']]||0)+(+d.Value||0)/100000);
  const labels=[],values=[];
  Object.entries(map).forEach(([k,v])=>v/total<0.02?small.push(k):(labels.push(k),values.push(v)));
  if(small.length){labels.push('Others (<2%)');values.push(small.reduce((a,c)=>a+map[c],0));}
  Plotly.newPlot('companyPie',[{labels,values,type:'pie',hole:0.35}]);
}

function renderTypeDonut(data){
  const map={};
  data.forEach(d=>map[d.Type]=(map[d.Type]||0)+(+d.Value||0)/100000);
  Plotly.newPlot('typeDonut',[{labels:Object.keys(map),values:Object.values(map),type:'pie',hole:0.6}]);
}

function clearDrill(){
  document.getElementById("drillInfo").style.display="none";
  applyFilters();
}

function exportExcel(){
  const ws=XLSX.utils.json_to_sheet(currentData);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Investments");
  XLSX.writeFile(wb,"Investment_Data.xlsx");
}

function exportPDF(){
  html2pdf().from(document.body).save("Investment_Report.pdf");
}
</script>

</body>
</html>
