<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AG Group | Investment Dashboard</title>

<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
:root {
  --bg:#f4f6f8;
  --card:#ffffff;
  --primary:#1a365d;
  --muted:#718096;
}

body {
  margin:0;
  font-family: Inter, system-ui, sans-serif;
  background:var(--bg);
  color:#2d3748;
}

header {
  background:var(--primary);
  color:white;
  padding:20px 30px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

header h1 { margin:0; font-size:22px; }
header small { color:#cbd5e0; font-size:13px; }

.container {
  padding:25px;
  max-width:1500px;
  margin:auto;
}

.section { margin-bottom:30px; }

.section-title {
  font-size:16px;
  font-weight:700;
  margin-bottom:15px;
}

.grid {
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:20px;
}

.card {
  background:var(--card);
  border-radius:12px;
  padding:20px;
  box-shadow:0 4px 6px rgba(0,0,0,.05);
}

select {
  width:250px;
  height:100px;
}

.table-wrap {
  max-height:650px;
  overflow:auto;
}

table {
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}

th {
  position:sticky;
  top:0;
  background:#f7fafc;
  padding:10px;
  border-bottom:2px solid #edf2f7;
}

td {
  padding:10px;
  border-bottom:1px solid #edf2f7;
}

tr:hover { background:#f1f5f9; }

#drillInfo {
  display:none;
  background:#fffaf0;
  border:1px solid #feebc8;
  padding:10px 15px;
  border-radius:8px;
  margin-bottom:10px;
}

button {
  padding:6px 12px;
  border:none;
  border-radius:6px;
  cursor:pointer;
}

.clear-btn { background:#e53e3e; color:white; }

.footer {
  margin-top:20px;
  font-size:12px;
  color:var(--muted);
  text-align:right;
}
</style>
</head>

<body>

<header>
  <div>
    <h1>AG Group â€“ Investment Portfolio</h1>
    <small>Period: <b id="periodText">--</b></small>
  </div>
  <div>
    <button onclick="exportPDF()">ðŸ“„ PDF</button>
    <button onclick="exportExcel()">ðŸ“Š Excel</button><br>
    <small id="lastUpdated">Last updated: --</small>
  </div>
</header>

<div class="container">

  <!-- FILTER -->
  <div class="card" style="margin-bottom:20px">
    <b>Investor Filter</b><br>
    <select id="investorFilter" multiple></select>
  </div>

  <!-- INSIGHTS -->
  <div class="section">
    <div class="section-title">Portfolio Insights</div>
    <div class="grid">
      <div class="card">
        <h3>Company Concentration</h3>
        <div id="companyPie"></div>
      </div>
      <div class="card">
        <h3>Asset Mix</h3>
        <div id="typeDonut" style="height:420px"></div>
      </div>
    </div>
  </div>

  <!-- TABLE -->
  <div class="section">
    <div class="section-title">Investment Repository Details</div>

    <div id="drillInfo">
      <span id="drillText"></span>
      <button class="clear-btn" onclick="clearDrill()">Clear</button>
    </div>

    <div class="card">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Investor</th>
              <th>Company</th>
              <th>Type</th>
              <th>Qty</th>
              <th>Value (â‚¹ L)</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="footer">Confidential â€“ For Client Use Only</div>
</div>

<script>
const DATA_URL = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLhf6NIZ6o8k4JVQQt3XVFwAgb-5h0UL-saIgjtF4PJTzhY5bVQPBHDnwrw1XVYL4OtzfKFMV2GiVVMMocZHY-JSorOpIKofX6dT1b2m1mjGXaKZzVgCVPLzB4SSYM7oH2wmz5Zfwbd_D5rD4k27gqgIiYmvSE3hqenxPFkYukj3qg2uvnI1bf5_Vf1z7m0AEyRpb3ZX7eSdUxsRezbB8WlJc5GtpNsiZobew_SI2z_6XNxJ9QhL-agOK91Zd-0XbWLVftPiZCbnOXXUq-IbF3jQFET18Q&lib=MLfLtmcdnFe_9PafX9g6m-beUs6YUnKQP";

let fullData = [], activeData = [];

fetch(DATA_URL)
  .then(r => r.json())
  .then(json => {
    fullData = json.data || [];
    activeData = fullData;

    document.getElementById("periodText").innerText = json.period || "--";
    document.getElementById("lastUpdated").innerText =
      "Last updated: " + (json.lastUpdated || new Date().toLocaleString());

    populateInvestorFilter();
    applyAll();
  });

function populateInvestorFilter(){
  const sel = document.getElementById("investorFilter");
  const investors = [...new Set(fullData.map(d=>d.Investor))].sort();
  sel.innerHTML = `<option value="ALL" selected>All</option>` +
    investors.map(i=>`<option>${i}</option>`).join("");
  sel.onchange = applyAll;
}

function getFiltered(){
  const sel = [...document.getElementById("investorFilter").selectedOptions].map(o=>o.value);
  if (sel.includes("ALL")) return fullData;
  return fullData.filter(d=>sel.includes(d.Investor));
}

function applyAll(){
  activeData = getFiltered();
  renderTable(activeData);
  renderCompanyPie(activeData);
  renderTypeDonut(activeData);
}

function renderTable(data){
  document.getElementById("tableBody").innerHTML = data.map(d=>`
    <tr>
      <td>${d.Investor}</td>
      <td>${d["Name of the Company"]}</td>
      <td>${d.Type}</td>
      <td>${d.Qty}</td>
      <td>${((+d.Value||0)/100000).toFixed(2)}</td>
      <td>${d.DOA}</td>
    </tr>`).join("");
}

function renderCompanyPie(data){
  const map={}, small=[], total=data.reduce((a,b)=>a+(+b.Value||0),0)/100000;
  data.forEach(d=>map[d["Name of the Company"]] = (map[d["Name of the Company"]]||0)+(+d.Value||0)/100000);

  const labels=[], values=[];
  Object.entries(map).forEach(([k,v])=> v/total<0.02 ? small.push(k) : (labels.push(k),values.push(v)));
  if(small.length){ labels.push("Others (<2%)"); values.push(small.reduce((a,c)=>a+map[c],0)); }

  Plotly.newPlot("companyPie",[{
    labels, values, type:"pie", hole:0.35
  }]);

  document.getElementById("companyPie").on("plotly_click",e=>{
    const l=e.points[0].label;
    activeData = l==="Others (<2%)"
      ? fullData.filter(d=>small.includes(d["Name of the Company"]))
      : fullData.filter(d=>d["Name of the Company"]===l);
    showDrill("Company: "+l,activeData);
  });
}

function renderTypeDonut(data){
  const map={};
  data.forEach(d=>map[d.Type]=(map[d.Type]||0)+(+d.Value||0)/100000);

  Plotly.newPlot("typeDonut",[{
    labels:Object.keys(map),
    values:Object.values(map),
    type:"pie",
    hole:0.6
  }]);

  document.getElementById("typeDonut").on("plotly_click",e=>{
    const l=e.points[0].label;
    activeData = fullData.filter(d=>d.Type===l);
    showDrill("Asset Type: "+l,activeData);
  });
}

function showDrill(t,data){
  document.getElementById("drillText").innerText=t;
  document.getElementById("drillInfo").style.display="block";
  renderTable(data);
}

function clearDrill(){
  document.getElementById("drillInfo").style.display="none";
  applyAll();
}

function exportExcel(){
  const ws=XLSX.utils.json_to_sheet(activeData);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Investments");
  XLSX.writeFile(wb,"Investment_Data.xlsx");
}

function exportPDF(){
  html2pdf().from(document.body).save("Investment_Report.pdf");
}
</script>

</body>
</html>
