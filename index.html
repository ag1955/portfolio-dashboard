<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AG Group | Investment Dashboard</title>

<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body{margin:0;font-family:Inter,system-ui;background:#f0f2f5}
header{background:#1a365d;color:#fff;padding:20px;display:flex;justify-content:space-between}
.container{max-width:1600px;margin:auto;padding:25px}
.card{background:#fff;padding:20px;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,.05);margin-bottom:20px}
.filters{display:flex;gap:20px;flex-wrap:wrap}
.filter-group select{width:200px;height:120px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
.tab{display:none}
.tab.active{display:block}
#top5{display:grid;grid-template-columns:repeat(5,1fr);gap:12px}
.top{background:#fffaf0;border-top:4px solid #d69e2e;padding:10px;border-radius:8px;text-align:center}
.table-wrap{max-height:600px;overflow:auto}
table{width:100%;border-collapse:collapse;font-size:13px}
th{background:#f7fafc;padding:8px;border-bottom:1px solid #e2e8f0}
td{padding:8px;border-bottom:1px solid #edf2f7}
#drillBanner{background:#fffaf0;border:1px solid #feebc8;padding:10px;border-radius:8px;margin-bottom:10px}
button{cursor:pointer}
.page-break{page-break-before:always}
</style>
</head>

<body>

<header>
  <div>
    <h2>AG Group – Investment Portfolio</h2>
    Period: <b id="periodText">--</b>
  </div>
  <div>
    <button onclick="exportPDF()">Export PDF</button>
    <button onclick="exportExcel()">Export Excel</button><br>
    <small id="lastUpdated">--</small>
  </div>
</header>

<div class="container">

<!-- FILTERS -->
<div class="card filters">
  <div class="filter-group">
    Investor<br>
    <select id="invF" multiple></select><br>
    <button onclick="clearFilter('invF')">Clear</button>
  </div>
  <div class="filter-group">
    Company<br>
    <select id="comF" multiple></select><br>
    <button onclick="clearFilter('comF')">Clear</button>
  </div>
  <div class="filter-group">
    Type<br>
    <select id="typF" multiple></select><br>
    <button onclick="clearFilter('typF')">Clear</button>
  </div>
</div>

<!-- TABS -->
<button onclick="showTab('insights')">Insights</button>
<button onclick="showTab('repo')">Repository</button>

<!-- INSIGHTS TAB -->
<div id="insights" class="tab active">
  <div class="grid">
    <div class="card">
      <h3 id="pieTitle"></h3>
      <div id="companyPie"></div>
    </div>
    <div class="card">
      <h3>Type Mix</h3>
      <div id="typeDonut"></div>
    </div>
  </div>
  <h3>Top 5 Summary</h3>
  <div id="top5"></div>
</div>

<!-- REPOSITORY TAB -->
<div id="repo" class="tab">
  <div id="drillBanner" style="display:none">
    <span id="drillText"></span>
    <button onclick="clearDrill()">Clear Drill</button>
  </div>
  <div class="table-wrap">
    <table id="repoTable">
      <thead>
        <tr>
          <th>Investor</th>
          <th>Company</th>
          <th>Type</th>
          <th>Qty</th>
          <th>Value (₹ L)</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>
</div>

</div>

<!-- EXPORT-ONLY CONTAINER -->
<div id="exportArea" style="display:none"></div>

<script>
/* ================= CONFIG ================= */
const DATA_URL = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLiuBF8qGiXLco-bq_QTS-C6ixwdJreZE5grEdR_Zz_B27butjuX1JKRbZAECXshOCgXuO4iuievHn6b7bNc3nt6xqI1TAKXOZkjLyy8yhe4MKKvhmKB7FllPtopmMBENt11nCExifDallRow8xQB63oTw-3CnB-xUtkJuP6dfnRlemz8NFEdNhDwu0SSHtDgZQCn38FTzzQAHN4pQzgLlLeAH3WHNb6IO_lymOJLT_2fNKqzfSILNJTN4Tptt4iWFgQ8ogNFDqQuY2mXDYZj7VwASG17A&lib=MLfLtmcdnFe_9PafX9g6m-beUs6YUnKQP";

/* ================= STATE ================= */
let rawData=[], filteredData=[], drillData=[];
const s=v=>String(v??"");
const effective=()=>drillData.length?drillData:filteredData;

/* ================= LOAD ================= */
fetch(DATA_URL).then(r=>r.json()).then(j=>{
  rawData=j.data||[];
  periodText.innerText=j.period||"--";
  lastUpdated.innerText=j.lastUpdated||"--";
  initFilters();
  applyFilters();
});

/* ================= TABS ================= */
function showTab(t){
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  document.getElementById(t).classList.add('active');
}

/* ================= FILTERS ================= */
const selected=id=>[...document.getElementById(id).selectedOptions].map(o=>o.value);

function rebuild(id,key,data){
  const sel=document.getElementById(id);
  const prev=selected(id);
  const vals=[...new Set(data.map(d=>s(d[key])))]
    .filter(v=>v!=="").sort();
  sel.innerHTML='<option value="All">All</option>'+vals.map(v=>`<option>${v}</option>`).join('');
  [...sel.options].forEach(o=>{
    if(prev.includes(o.value)||(!prev.length&&o.value==="All")) o.selected=true;
  });
}

function initFilters(){
  ['invF','comF','typF'].forEach(id=>document.getElementById(id).onchange=applyFilters);
  rebuild('invF','Investor',rawData);
  rebuild('comF','Name of the Company',rawData);
  rebuild('typF','Type',rawData);
}

function applyFilters(){
  const iv=selected('invF'), co=selected('comF'), ty=selected('typF');

  filteredData=rawData.filter(d=>
    (iv.includes("All")||iv.includes(s(d.Investor))) &&
    (co.includes("All")||co.includes(s(d["Name of the Company"]))) &&
    (ty.includes("All")||ty.includes(s(d.Type)))
  );

  rebuild('invF','Investor', rawData.filter(d=>
    (co.includes("All")||co.includes(s(d["Name of the Company"]))) &&
    (ty.includes("All")||ty.includes(s(d.Type)))
  ));
  rebuild('comF','Name of the Company', rawData.filter(d=>
    (iv.includes("All")||iv.includes(s(d.Investor))) &&
    (ty.includes("All")||ty.includes(s(d.Type)))
  ));
  rebuild('typF','Type', rawData.filter(d=>
    (iv.includes("All")||iv.includes(s(d.Investor))) &&
    (co.includes("All")||co.includes(s(d["Name of the Company"])))
  ));

  clearDrill(false);
  renderAll();
}

function clearFilter(id){
  [...document.getElementById(id).options].forEach(o=>o.selected=o.value==="All");
  applyFilters();
}

/* ================= RENDER ================= */
function renderAll(){
  renderCharts();
  renderTop5();
  renderTable(effective());
}

/* ================= CHARTS ================= */
function renderCharts(){
  const data=effective();
  const co=selected('comF');
  const total=data.reduce((a,b)=>a+(+b.Value||0),0)/100000;

  let labels=[], values=[], others=0;
  if(co.length===1&&!co.includes("All")){
    pieTitle.innerText="Investor-wise Holding";
    const m={};
    data.forEach(d=>m[s(d.Investor)]=(m[s(d.Investor)]||0)+(+d.Value||0)/100000);
    labels=Object.keys(m); values=Object.values(m);
  } else {
    pieTitle.innerText="Company Concentration";
    const m={};
    data.forEach(d=>m[s(d["Name of the Company"])]=(m[s(d["Name of the Company"])]||0)+(+d.Value||0)/100000);
    Object.entries(m).forEach(([k,v])=>{
      if(total>0&&v/total<0.02) others+=v;
      else{labels.push(k);values.push(v);}
    });
    if(others>0){labels.push("Others (<2%)");values.push(others);}
  }

  Plotly.newPlot(companyPie,[{labels,values,type:"pie",hole:0.35}],
    {annotations:[{text:"₹ "+total.toFixed(2)+" L",showarrow:false}]});

  const t={};
  data.forEach(d=>t[s(d.Type)]=(t[s(d.Type)]||0)+(+d.Value||0)/100000);
  Plotly.newPlot(typeDonut,[{labels:Object.keys(t),values:Object.values(t),type:"pie",hole:0.6}],
    {annotations:[{text:"₹ "+total.toFixed(2)+" L",showarrow:false}]});
}

/* ================= TOP 5 ================= */
function renderTop5(){
  const m={};
  effective().forEach(d=>m[s(d["Name of the Company"])]=(m[s(d["Name of the Company"])]||0)+(+d.Value||0)/100000);
  top5.innerHTML=Object.entries(m).sort((a,b)=>b[1]-a[1]).slice(0,5)
    .map(([k,v])=>`<div class="top">${k}<br>₹ ${v.toFixed(2)} L</div>`).join('');
}

/* ================= TABLE ================= */
function renderTable(data){
  tableBody.innerHTML=data.map(d=>`
    <tr>
      <td>${s(d.Investor)}</td>
      <td>${s(d["Name of the Company"])}</td>
      <td>${s(d.Type)}</td>
      <td>${d.Qty}</td>
      <td>${(+d.Value/100000).toFixed(2)}</td>
      <td>${d.DOA}</td>
    </tr>`).join('');
}

/* ================= DRILL ================= */
function clearDrill(r=true){
  drillData=[];
  drillBanner.style.display="none";
  if(r) renderAll();
}

/* ================= EXPORT ================= */
function exportPDF(){
  const box=document.getElementById("exportArea");
  box.innerHTML="";

  box.innerHTML+=`<h2>AG Group – Investment Portfolio</h2>
    <p><b>Period:</b> ${periodText.innerText}<br>
    <b>Generated:</b> ${new Date().toLocaleString()}</p>`;

  box.appendChild(companyPie.cloneNode(true));
  box.appendChild(typeDonut.cloneNode(true));
  box.appendChild(top5.cloneNode(true));

  box.innerHTML+=`<div class="page-break"></div>
    <h3>Detailed Investment Repository</h3>`;

  box.appendChild(repoTable.cloneNode(true));

  html2pdf().set({
    margin:12,
    filename:"AG_Investment_Report.pdf",
    jsPDF:{format:"a3"},
    pagebreak:{mode:["css"]}
  }).from(box).save();
}

function exportExcel(){
  const wb=XLSX.utils.book_new();
  const rows=effective().map(d=>({
    Investor:s(d.Investor),
    Company:s(d["Name of the Company"]),
    Type:s(d.Type),
    Qty:d.Qty,
    "Value (₹ L)": (+d.Value/100000).toFixed(2),
    Date:d.DOA
  }));
  XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(rows),"Repository");
  XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet([
    {Metric:"Period",Value:periodText.innerText},
    {Metric:"Total (₹ L)",Value:rows.reduce((a,b)=>a+parseFloat(b["Value (₹ L)"]),0).toFixed(2)},
    {Metric:"Generated",Value:new Date().toLocaleString()}
  ]),"Summary");
  XLSX.writeFile(wb,"AG_Investment_Results.xlsx");
}
</script>

</body>
</html>
