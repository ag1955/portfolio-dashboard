<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AG Group | Investment Dashboard</title>

<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body{margin:0;font-family:Inter,system-ui;background:#f0f2f5}
header{background:#1a365d;color:#fff;padding:20px;display:flex;justify-content:space-between}
.container{max-width:1600px;margin:auto;padding:25px}
.card{background:#fff;padding:20px;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,.05);margin-bottom:20px}
.filters{display:flex;gap:20px;flex-wrap:wrap}
.filters select{width:200px;height:120px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
#top5{display:grid;grid-template-columns:repeat(5,1fr);gap:12px}
.top{background:#fffaf0;border-top:4px solid #d69e2e;padding:10px;border-radius:8px;text-align:center}
.tab{display:none}
.tab.active{display:block}
.table-wrap{max-height:600px;overflow:auto}
table{width:100%;border-collapse:collapse;font-size:13px}
th{position:sticky;top:0;background:#f7fafc;padding:8px}
td{padding:8px;border-bottom:1px solid #edf2f7}
</style>
</head>

<body>

<header>
  <div>
    <h2>AG Group – Investment Portfolio</h2>
    Period: <b id="periodText">--</b>
  </div>
  <div>
    <button onclick="exportPDF()">PDF</button>
    <button onclick="exportExcel()">Excel</button><br>
    <small id="lastUpdated">--</small>
  </div>
</header>

<div class="container">

<!-- FILTERS -->
<div class="card filters">
  <div>Investor<br><select id="invF" multiple></select></div>
  <div>Company<br><select id="comF" multiple></select></div>
  <div>Type<br><select id="typF" multiple></select></div>
  <div><br><button onclick="resetAll()">Reset All</button></div>
</div>

<!-- TABS -->
<button onclick="showTab('insights')">Insights</button>
<button onclick="showTab('repo')">Repository</button>

<!-- INSIGHTS -->
<div id="insights" class="tab active">
  <div class="grid">
    <div class="card">
      <h3 id="pieTitle"></h3>
      <div id="companyPie"></div>
    </div>
    <div class="card">
      <h3 id="donutTitle"></h3>
      <div id="typeDonut"></div>
    </div>
  </div>
  <h3>Top 5 Summary</h3>
  <div id="top5"></div>
</div>

<!-- REPOSITORY -->
<div id="repo" class="tab">
  <input placeholder="Search..." onkeyup="searchTable(this.value)">
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Investor</th>
          <th>Company</th>
          <th>Type</th>
          <th>Qty</th>
          <th>Value (₹ L)</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>
</div>

</div>

<script>
const DATA_URL = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLhf6NIZ6o8k4JVQQt3XVFwAgb-5h0UL-saIgjtF4PJTzhY5bVQPBHDnwrw1XVYL4OtzfKFMV2GiVVMMocZHY-JSorOpIKofX6dT1b2m1mjGXaKZzVgCVPLzB4SSYM7oH2wmz5Zfwbd_D5rD4k27gqgIiYmvSE3hqenxPFkYukj3qg2uvnI1bf5_Vf1z7m0AEyRpb3ZX7eSdUxsRezbB8WlJc5GtpNsiZobew_SI2z_6XNxJ9QhL-agOK91Zd-0XbWLVftPiZCbnOXXUq-IbF3jQFET18Q&lib=MLfLtmcdnFe_9PafX9g6m-beUs6YUnKQP";

let rawData = [];
let filteredData = [];

/* LOAD */
fetch(DATA_URL)
  .then(r=>r.json())
  .then(json=>{
    rawData = json.data || [];
    document.getElementById("periodText").innerText = json.period || "--";
    document.getElementById("lastUpdated").innerText = json.lastUpdated || "--";
    initFilters();
    applyFilters();
  });

/* TABS */
function showTab(tab){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById(tab).classList.add('active');
}

/* FILTER HELPERS */
function selected(id){
  return [...document.getElementById(id).selectedOptions].map(o=>o.value);
}

function buildFilter(id,key,data){
  const sel=document.getElementById(id);
  const prev=selected(id);
  const vals=[...new Set(data.map(d=>d[key]))].sort();

  sel.innerHTML='<option value="All">All</option>'+
    vals.map(v=>`<option value="${v}">${v}</option>`).join('');

  [...sel.options].forEach(o=>{
    if(prev.includes(o.value) || (prev.length===0 && o.value==="All")){
      o.selected=true;
    }
  });
}

/* INIT FILTERS */
function initFilters(){
  ['invF','comF','typF'].forEach(id=>{
    document.getElementById(id).onchange=applyFilters;
  });
  rebuildFilters(rawData);
}

function rebuildFilters(base){
  buildFilter('invF','Investor',base);
  buildFilter('comF','Name of the Company',base);
  buildFilter('typF','Type',base);
}

/* APPLY FILTERS */
function applyFilters(){
  const iv=selected('invF');
  const co=selected('comF');
  const ty=selected('typF');

  filteredData = rawData.filter(d =>
    (iv.includes("All")||iv.includes(d.Investor)) &&
    (co.includes("All")||co.includes(d["Name of the Company"])) &&
    (ty.includes("All")||ty.includes(d.Type))
  );

  buildFilter('invF','Investor',
    rawData.filter(d=>
      (co.includes("All")||co.includes(d["Name of the Company"])) &&
      (ty.includes("All")||ty.includes(d.Type))
    )
  );

  buildFilter('comF','Name of the Company',
    rawData.filter(d=>
      (iv.includes("All")||iv.includes(d.Investor)) &&
      (ty.includes("All")||ty.includes(d.Type))
    )
  );

  buildFilter('typF','Type',
    rawData.filter(d=>
      (iv.includes("All")||iv.includes(d.Investor)) &&
      (co.includes("All")||co.includes(d["Name of the Company"]))
    )
  );

  renderAll();
}

/* RENDER */
function renderAll(){
  renderCharts();
  renderTop5();
  renderTable(filteredData);
}

/* CHARTS */
function renderCharts(){
  const iv=selected('invF');
  const co=selected('comF');
  const total=filteredData.reduce((a,b)=>a+(+b.Value||0),0)/100000;

  /* COMPANY PIE */
  let pieTitle="";
  let labels=[], values=[];
  if(co.length===1 && !co.includes("All")){
    pieTitle="Investor-wise Holding";
    const map={};
    filteredData.forEach(d=>{
      map[d.Investor]=(map[d.Investor]||0)+(+d.Value||0)/100000;
    });
    labels=Object.keys(map);
    values=Object.values(map);
  } else {
    pieTitle="Company Concentration";
    const rawMap={};
    filteredData.forEach(d=>{
      rawMap[d["Name of the Company"]] =
        (rawMap[d["Name of the Company"]]||0)+(+d.Value||0)/100000;
    });
    let others=0;
    Object.entries(rawMap).forEach(([k,v])=>{
      if(v/total < 0.02) others+=v;
      else { labels.push(k); values.push(v); }
    });
    if(others>0){ labels.push("Others (<2%)"); values.push(others); }
  }

  document.getElementById("pieTitle").innerText=pieTitle;
  Plotly.newPlot("companyPie",[{
    labels, values, type:"pie", hole:0.35
  }],{
    annotations:[{text:"₹ "+total.toFixed(2)+" L",showarrow:false}]
  });

  /* DONUT */
  document.getElementById("donutTitle").innerText="Type Mix";
  const tMap={};
  filteredData.forEach(d=>{
    tMap[d.Type]=(tMap[d.Type]||0)+(+d.Value||0)/100000;
  });

  Plotly.newPlot("typeDonut",[{
    labels:Object.keys(tMap),
    values:Object.values(tMap),
    type:"pie",
    hole:0.6
  }],{
    annotations:[{text:"₹ "+total.toFixed(2)+" L",showarrow:false,font:{size:18}}]
  });
}

/* TOP 5 */
function renderTop5(){
  const iv=selected('invF');
  const co=selected('comF');
  let map={};

  if(co.length===1 && !co.includes("All")){
    filteredData.forEach(d=>{
      map[d.Investor]=(map[d.Investor]||0)+(+d.Value||0)/100000;
    });
  } else if(iv.length===1 && !iv.includes("All")){
    filteredData.forEach(d=>{
      map[d["Name of the Company"]] =
        (map[d["Name of the Company"]]||0)+(+d.Value||0)/100000;
    });
  } else {
    filteredData.forEach(d=>{
      map[d["Name of the Company"]] =
        (map[d["Name of the Company"]]||0)+(+d.Value||0)/100000;
    });
  }

  document.getElementById("top5").innerHTML =
    Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,5)
      .map(([k,v])=>`<div class="top">${k}<br>₹ ${v.toFixed(2)} L</div>`)
      .join('');
}

/* TABLE */
function renderTable(data){
  document.getElementById("tableBody").innerHTML =
    data.map(d=>`
      <tr>
        <td>${d.Investor}</td>
        <td>${d["Name of the Company"]}</td>
        <td>${d.Type}</td>
        <td>${d.Qty}</td>
        <td>${(+d.Value/100000).toFixed(2)}</td>
        <td>${d.DOA}</td>
      </tr>`).join('');
}

function searchTable(q){
  q=q.toLowerCase();
  renderTable(filteredData.filter(d=>JSON.stringify(d).toLowerCase().includes(q)));
}

/* UTILS */
function resetAll(){
  ['invF','comF','typF'].forEach(id=>document.getElementById(id).selectedIndex=0);
  applyFilters();
}
function exportExcel(){
  const ws=XLSX.utils.json_to_sheet(filteredData);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Data");
  XLSX.writeFile(wb,"Investments.xlsx");
}
function exportPDF(){
  html2pdf().from(document.body).save("Investment_Report.pdf");
}
</script>

</body>
</html>
