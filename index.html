<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AG Group | Investment Dashboard</title>
<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

<style>
:root {
  --bg:#f4f6f8;
  --card:#ffffff;
  --primary:#1a365d;
  --muted:#718096;
}

body {
  margin:0;
  font-family: Inter, system-ui, sans-serif;
  background:var(--bg);
  color:#2d3748;
}

/* HEADER */
header {
  background:var(--primary);
  color:white;
  padding:20px 30px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

header h1 {
  margin:0;
  font-size:22px;
}

header small {
  color:#cbd5e0;
  font-size:13px;
}

/* CONTAINER */
.container {
  padding:25px;
  max-width:1500px;
  margin:auto;
}

/* SECTION */
.section {
  margin-bottom:30px;
}

.section-title {
  font-size:16px;
  font-weight:700;
  color:#2d3748;
  margin-bottom:15px;
}

/* GRID */
.grid {
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:20px;
}

/* CARDS */
.card {
  background:var(--card);
  border-radius:12px;
  padding:20px;
  box-shadow:0 4px 6px rgba(0,0,0,.05);
}

/* TABLE */
.table-wrap {
  max-height:650px;
  overflow:auto;
}

table {
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}

th {
  position:sticky;
  top:0;
  background:#f7fafc;
  padding:10px;
  border-bottom:2px solid #edf2f7;
}

td {
  padding:10px;
  border-bottom:1px solid #edf2f7;
}

tr:hover {
  background:#f1f5f9;
}

/* DRILL INFO */
#drillInfo {
  margin-bottom:10px;
  padding:10px 15px;
  background:#fffaf0;
  border:1px solid #feebc8;
  border-radius:8px;
  display:none;
  font-size:13px;
}

.clear-btn {
  float:right;
  background:#e53e3e;
  color:white;
  border:none;
  padding:5px 10px;
  border-radius:6px;
  cursor:pointer;
}

.footer {
  margin-top:20px;
  font-size:12px;
  color:var(--muted);
  text-align:right;
}
</style>
</head>

<body>

<header>
  <div>
    <h1>AG Group – Investment Portfolio</h1>
    <small>Period: <b>April 2025</b></small>
  </div>
  <div>
    <small id="lastUpdated">Last updated: --</small>
  </div>
</header>

<div class="container">

  <!-- SECTION 1 -->
  <div class="section">
    <div class="section-title">Portfolio Insights</div>
    <div class="grid">
      <div class="card">
        <h3>Company Concentration</h3>
        <div id="companyPie"></div>
      </div>
      <div class="card">
        <h3>Asset Mix</h3>
        <div id="typeDonut" style="height:420px;"></div>
      </div>
    </div>
  </div>

  <!-- SECTION 2 -->
  <div class="section">
    <div class="section-title">Investment Repository Details</div>

    <div id="drillInfo">
      <span id="drillText"></span>
      <button class="clear-btn" onclick="clearDrill()">Clear</button>
    </div>

    <div class="card">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Investor</th>
              <th>Company</th>
              <th>Type</th>
              <th>Qty</th>
              <th>Value (₹ L)</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="footer">Confidential – For Client Use Only</div>
</div>

<script>
const DATA_URL = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLiFpng51MNw2Ci5QajK-UqiQqD0V3GzeoHMr_qgG519YSzudwpvVkoYiUZZJ2X0NJqpBZfb4sr1hgj86-v7gOyEwr5yPn4-GRdO7K40K2LqSCk477ExUZfARMOfS-T_L3nBkyNYQG8o8Pr6Zlt-zerQQyrvO9MTrjjpyc0-YKGTEHs7r_LAJuuTISL2jvwUQTWhfgJeffOxCVoMf0w43mU_hRdMFQCM6pgYI8bI_nc-f4-xfMJJFWb59aGWKouF3CXFvvNouzC8hGQdjz-Fdhfh-KPieg&lib=MLfLtmcdnFe_9PafX9g6m-beUs6YUnKQP";

let fullData = [];
let activeData = [];

/* LOAD DATA */
fetch(DATA_URL)
  .then(r => r.json())
  .then(json => {

    // Handle both API formats safely
    if (Array.isArray(json)) {
      fullData = json;
      document.getElementById("lastUpdated").innerText =
        "Last updated: " + new Date().toLocaleString();
    } else {
      fullData = json.data || [];
      document.getElementById("lastUpdated").innerText =
        "Last updated: " + (json.lastUpdated || "—");
    }

    activeData = fullData;

    renderTable(fullData);
    renderCompanyPie(fullData);
    renderTypeDonut(fullData);
  })
  .catch(err => {
    console.error(err);
    alert("Failed to load data");
  });

/* TABLE */
function renderTable(data){
  document.getElementById("tableBody").innerHTML = data.map(d=>`
    <tr>
      <td>${d.Investor||""}</td>
      <td>${d["Name of the Company"]||""}</td>
      <td>${d.Type||""}</td>
      <td>${d.Qty||""}</td>
      <td>${((+d.Value||0)/100000).toFixed(2)}</td>
      <td>${d.DOA||""}</td>
    </tr>
  `).join("");
}

/* PIE DRILL */
function renderCompanyPie(data){
  const map={}, small=[], total=data.reduce((a,b)=>a+(+b.Value||0),0)/100000;

  data.forEach(d=>{
    map[d["Name of the Company"]] =
      (map[d["Name of the Company"]]||0)+(+d.Value||0)/100000;
  });

  const labels=[], values=[];
  Object.entries(map).forEach(([k,v])=>{
    if(v/total < 0.02) small.push(k);
    else { labels.push(k); values.push(v); }
  });

  if(small.length){
    labels.push("Others (<2%)");
    values.push(small.reduce((a,c)=>a+map[c],0));
  }

  Plotly.newPlot("companyPie",[{
    labels, values, type:"pie", hole:0.35
  }],{
    margin:{t:20},
    annotations:[{
      text:"₹ "+total.toFixed(2)+" L",
      showarrow:false
    }]
  });

  document.getElementById("companyPie")
    .on("plotly_click", e=>{
      const label=e.points[0].label;
      activeData = label==="Others (<2%)"
        ? fullData.filter(d=>small.includes(d["Name of the Company"]))
        : fullData.filter(d=>d["Name of the Company"]===label);

      showDrill("Company: "+label, activeData);
    });
}

/* DONUT DRILL */
function renderTypeDonut(data){
  const map={}, total=data.reduce((a,b)=>a+(+b.Value||0),0)/100000;

  data.forEach(d=>{
    map[d.Type]=(map[d.Type]||0)+(+d.Value||0)/100000;
  });

  Plotly.newPlot("typeDonut",[{
    labels:Object.keys(map),
    values:Object.values(map),
    type:"pie",
    hole:0.6
  }],{
    margin:{t:20},
    annotations:[{
      text:"₹ "+total.toFixed(2)+" L",
      showarrow:false,
      font:{size:18}
    }]
  });

  document.getElementById("typeDonut")
    .on("plotly_click", e=>{
      const label=e.points[0].label;
      activeData = fullData.filter(d=>d.Type===label);
      showDrill("Asset Type: "+label, activeData);
    });
}

/* DRILL UI */
function showDrill(text,data){
  document.getElementById("drillText").innerText=text;
  document.getElementById("drillInfo").style.display="block";
  renderTable(data);
}

function clearDrill(){
  activeData = fullData;
  document.getElementById("drillInfo").style.display="none";
  renderTable(fullData);
}
</script>

</body>
</html>


